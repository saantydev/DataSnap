<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot - DataSnap</title>
    <link rel="shortcut icon" href="/config/icons/logo-solo.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/config/css/sidebar.css">
    <link rel="stylesheet" href="/config/css/chatbot.css">
    <script src="/config/js/theme.js"></script>
    <meta name="csrf-token" content="<?php echo htmlspecialchars($_SESSION['csrf_token'] ?? ''); ?>">

</head>

<body class="flex" style="background-color: var(--color-fondo);">
    <?php $active = 'chatbot'; include __DIR__ . '/partials/sidebar.php'; ?>

    <main class="flex-1 md:ml-72 p-4 md:p-6">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold mb-2" style="color: var(--color-texto);">ðŸ¤– ChatBot IA</h2>
                <p style="color: var(--color-texto-secundario);">Chatea con tus bases de datos usando lenguaje natural
                </p>
            </div>

            <!-- Database Selector -->
            <div id="databaseSelector" class="database-selector">
                <div class="flex items-center gap-3 mb-3">
                    <i class="material-icons text-amber-600">storage</i>
                    <h3 class="font-semibold text-amber-800">Selecciona una base de datos</h3>
                </div>
                <select id="databaseSelect" class="w-full p-3 border rounded-lg focus:ring-2"
                    style="background-color: var(--color-fondo); border-color: #f59e0b; color: var(--color-texto); focus:ring-color: #f59e0b;">
                    <option value="">Selecciona una base de datos...</option>
                </select>
                <p class="text-sm text-amber-700 mt-2">Elige la base de datos con la que quieres chatear</p>
            </div>

            <!-- Chat Container -->
            <div class="chat-container rounded-lg shadow-sm border"
                style="background-color: var(--color-fondo); border-color: var(--color-texto-secundario);">
                <!-- Chat Messages -->
                <div id="chatMessages" class="chat-messages">
                    <div class="message bot">
                        <div class="message-avatar">ðŸ¤–</div>
                        <div class="message-content">
                            <p>Â¡Hola! Soy tu asistente de IA para consultar bases de datos. Selecciona una base de datos
                                arriba y podrÃ¡s hacerme preguntas como:</p>
                            <ul class="mt-2 space-y-1 text-sm">
                                <li>â€¢ "Â¿CuÃ¡ntos registros hay en total?"</li>
                                <li>â€¢ "MuÃ©strame los usuarios mÃ¡s activos"</li>
                                <li>â€¢ "Â¿CuÃ¡l es el promedio de ventas?"</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="typing-indicator">
                    <div class="message-avatar">ðŸ¤–</div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span class="text-sm text-gray-500">El asistente estÃ¡ escribiendo...</span>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-container">
                    <div class="flex gap-3">
                        <input type="text" id="chatInput" placeholder="Escribe tu pregunta sobre la base de datos..."
                            class="flex-1 p-3 border rounded-lg focus:ring-2 disabled:cursor-not-allowed"
                            style="background-color: var(--color-fondo2); border-color: var(--color-texto-secundario); color: var(--color-texto); focus:ring-color: var(--color-primario); focus:border-color: var(--color-primario);"
                            disabled>
                        <button id="sendButton"
                            class="px-6 py-3 text-white rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            style="background-color: var(--color-primario);"
                            disabled>
                            <i class="material-icons">send</i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="mt-6 rounded-lg p-4"
                style="background-color: var(--color-fondo); border: 1px solid var(--color-texto-secundario);">
                <div class="flex items-start gap-3">
                    <i class="material-icons" style="color: var(--color-primario);">info</i>
                    <div>
                        <h4 class="font-semibold mb-2" style="color: var(--color-texto);">Consejos para mejores
                            resultados:</h4>
                        <ul class="text-sm space-y-1" style="color: var(--color-texto-secundario);">
                            <li>â€¢ SÃ© especÃ­fico en tus preguntas</li>
                            <li>â€¢ Puedes preguntar por estadÃ­sticas, filtros o bÃºsquedas</li>
                            <li>â€¢ El asistente entiende espaÃ±ol natural</li>
                            <li>â€¢ Si no entiendes una respuesta, pide que la explique</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedDatabase = null;
        let chatHistory = [];

        document.addEventListener('DOMContentLoaded', function () {
            loadDatabases();
            setupEventListeners();
            checkUrlParams();
        });

        function setupEventListeners() {
            const databaseSelect = document.getElementById('databaseSelect');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');

            databaseSelect.addEventListener('change', function () {
                selectedDatabase = this.value;
                if (selectedDatabase) {
                    enableChat();
                    addBotMessage(`Â¡Perfecto! Ahora puedes hacerme preguntas sobre la base de datos "${this.options[this.selectedIndex].text}"`);
                } else {
                    disableChat();
                }
            });

            chatInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const databaseId = urlParams.get('database');
            if (databaseId) {
                // Esperar a que se carguen las bases de datos
                setTimeout(() => {
                    const select = document.getElementById('databaseSelect');
                    select.value = databaseId;
                    selectedDatabase = databaseId;
                    enableChat();
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        addBotMessage(`Â¡Perfecto! Ahora puedes hacerme preguntas sobre la base de datos "${selectedOption.text}"`);
                    }
                }, 500);
            }
        }

        async function loadDatabases() {
            try {
                const response = await fetch('/files/list');
                const data = await response.json();

                if (data.success && data.archivos) {
                    const select = document.getElementById('databaseSelect');
                    data.archivos.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = file.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading databases:', error);
                addBotMessage('Error al cargar las bases de datos. Por favor, recarga la pÃ¡gina.');
            }
        }

        function enableChat() {
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('databaseSelector').style.display = 'none';
        }

        function disableChat() {
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('databaseSelector').style.display = 'block';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !selectedDatabase) return;

            // Add user message
            addUserMessage(message);
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                const response = await fetch('/chatbot/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        message: message,
                        database_id: selectedDatabase
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addBotMessage(data.response);
                } else {
                    addBotMessage('Lo siento, hubo un error procesando tu consulta: ' + (data.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addBotMessage('Lo siento, hubo un error de conexiÃ³n. Por favor, intenta de nuevo.');
            } finally {
                hideTypingIndicator();
            }
        }

        function addUserMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">ðŸ‘¤</div>
                <div class="message-content">
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addBotMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-avatar">ðŸ¤–</div>
                <div class="message-content">
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>