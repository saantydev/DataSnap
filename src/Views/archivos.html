<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mis Archivos - Datasnap</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- CSRF token para fetch/form -->
    <meta name="csrf-token" content="<?php echo htmlspecialchars($_SESSION['csrf_token'] ?? ''); ?>">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/config/css/sidebar.css">
    <link rel="stylesheet" href="/config/css/archivos.css">
    <script src="/config/js/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="body-archivos">
    <?php $active = 'files'; include __DIR__ . '/partials/sidebar.php'; ?>
    <main class="main-content">

        <div class="titulo">
            <h2 class="page-title">Mis archivos</h2>
            <div class="filter-bar">
                <div class="filter-container">
                    <div class="search-container">
                        <input type="text" id="filterInput" placeholder="Buscar archivos..." class="search-input">
                        <img src="/config/icons/material-symbols_search.svg" alt="Buscar" class="search-icon">
                    </div>
                    <div class="filter-controls">
                        <select id="typeFilter" class="filter-select">
                            <option value="">Todos</option>
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="sql">SQL</option>
                            <option value="txt">TXT</option>
                            <option value="xlsx">XLSX</option>
                        </select>
                        <select id="dateFilter" class="filter-select">
                            <option value="">Fecha</option>
                            <option value="reciente">Más reciente</option>
                            <option value="antiguo">Más antiguo</option>
                        </select>
                        <button id="sortBtn" title="Cambiar orden" class="sort-btn">
                            <img id="sortIcon" src="/config/icons/tabler_sort-ascending.svg" alt="Ordenar" class="sort-icon">
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs mb-6">
            <div class="tab active" data-tab="todos">Todos los archivos</div>
            <div class="tab inactive" data-tab="originales">Archivos originales</div>
            <div class="tab inactive" data-tab="modificados">Archivos modificados</div>
        </div>

        <!-- Estado vacío -->
        <div id="emptyState" class="empty-state hidden">
            <img src="/config/icons/file.svg" alt="No files" class="empty-icon">
            <h3 class="empty-title">No tienes archivos aún</h3>
            <p class="empty-text">Sube tu primer archivo para comenzar a optimizarlo</p>
        </div>

        <!-- Tabla de archivos -->
        <div id="filesTableContainer" class="hidden">
            <table class="files-table">
                <thead>
                    <tr>
                        <th class="table-header">Nombre</th>
                        <th class="table-header">Tipo</th>
                        <th class="table-header">Tamaño</th>
                        <th class="table-header">Fecha</th>
                        <th class="table-header">Estado</th>
                        <th class="table-header table-header-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="filesTableBody">
                </tbody>
            </table>
        </div>

    </main>

    <script>
        // Estado de ordenamiento
        let sortOrder = 'asc'; // 'asc' o 'desc'

        // Cargar archivos al iniciar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadFiles();

            // Configurar event listeners para filtros
            setupFilters();

            // Inicializar icono de ordenamiento
            updateSortIcon();

            // Mostrar todos los archivos por defecto
            setTimeout(() => filterFilesByTab('todos'), 100);
        });

        // Configurar filtros
        function setupFilters() {
            const filterInput = document.getElementById('filterInput');
            const typeFilter = document.getElementById('typeFilter');
            const dateFilter = document.getElementById('dateFilter');
            const sortBtn = document.getElementById('sortBtn');

            filterInput.addEventListener('input', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            dateFilter.addEventListener('change', applyFilters);
            sortBtn.addEventListener('click', function(e) {
                console.log('Sort button clicked');
                toggleSort();
            });
        }

        // Alternar ordenamiento
        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            updateSortIcon();
            applyFilters();
        }

        // Actualizar icono de ordenamiento
        function updateSortIcon() {
            const sortIcon = document.getElementById('sortIcon');
            if (sortIcon) {
                const newSrc = sortOrder === 'asc'
                    ? '/config/icons/tabler_sort-ascending.svg'
                    : '/config/icons/tabler_sort-descending.svg';
                console.log('Changing sort icon to:', newSrc, 'Current order:', sortOrder);
                sortIcon.src = newSrc + '?t=' + Date.now(); // Cache buster
                sortIcon.alt = sortOrder === 'asc' ? 'Orden ascendente' : 'Orden descendente';
            } else {
                console.error('Sort icon element not found');
            }
        }

        // Aplicar filtros
        function applyFilters() {
            const filterText = document.getElementById('filterInput').value.toLowerCase();
            const typeValue = document.getElementById('typeFilter').value;
            const dateValue = document.getElementById('dateFilter').value;

            const rows = document.querySelectorAll('#filesTableBody tr');

            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const type = row.cells[1].textContent.toLowerCase();
                const date = row.cells[3].textContent;

                let show = true;

                // Filtro de texto
                if (filterText && !name.includes(filterText)) {
                    show = false;
                }

                // Filtro de tipo
                if (typeValue && !type.includes(typeValue)) {
                    show = false;
                }

                // Filtro de fecha (simplificado)
                if (dateValue) {
                    // Aquí podrías implementar lógica más compleja para fechas
                    // Por ahora solo verifica si contiene el texto
                }

                row.style.display = show ? '' : 'none';
            });
        }

        // Función para cargar archivos desde el servidor
        function loadFiles() {
            fetch('/files/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.archivos && data.archivos.length > 0) {
                        populateTable(data.archivos);
                        document.getElementById('filesTableContainer').classList.remove('hidden');
                        document.getElementById('emptyState').classList.add('hidden');
                    } else {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('filesTableContainer').classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('filesTableContainer').classList.add('hidden');
                });
        }

        // Función para poblar la tabla con los archivos
        function populateTable(files) {
            const tbody = document.getElementById('filesTableBody');
            tbody.innerHTML = '';

            files.forEach(file => {
                const row = document.createElement('tr');
                row.dataset.fileId = file.id;
                row.dataset.fileStatus = file.estado || 'original';

                // Formatear tamaño (asegurarse de que sea número)
                const sizeBytes = parseInt(file.tamano) || 0;
                const sizeMB = (sizeBytes / (1024 * 1024)).toFixed(2) + ' MB';

                // Formatear fecha
                const date = new Date(file.fecha_subida);
                const formattedDate = date.toLocaleDateString('es-ES');

                // Obtener tipo de archivo desde la extensión
                const fileName = file.nombre || '';
                const extension = fileName.split('.').pop()?.toLowerCase() || 'unknown';
                const fileType = ['sql', 'csv', 'txt', 'json', 'xlsx', 'xls'].includes(extension) ? extension : 'file';

                // Estado del archivo
                let statusText = 'Original';
                let actionButton = `<button class="btn-optimize inline-flex items-center px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors" onclick="optimizeFile(${file.id})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" class="mr-1">
                        <path d="M20.285 6.709l-11.025 11.187-5.561-5.561 1.414-1.414 4.147 4.147 9.611-9.61z" fill="currentColor"/>
                    </svg> Optimizar
                </button>`;

                if (file.estado === 'optimizado') {
                    statusText = 'Optimizado';
                    actionButton = `<a href="/files/download?id=${file.id}" class="btn-download inline-flex items-center px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" class="mr-1">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" fill="none" stroke="currentColor" stroke-width="2"/>
                            <polyline points="7,10 12,15 17,10" fill="none" stroke="currentColor" stroke-width="2"/>
                            <line x1="12" y1="15" x2="12" y2="3" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg> Descargar
                    </a>`;
                } else if (file.estado === 'pendiente') {
                    statusText = 'Procesando...';
                    actionButton = '<span class="inline-flex items-center px-3 py-1 text-sm bg-gray-400 text-white rounded-md cursor-not-allowed">Procesando...</span>';
                }

                row.innerHTML = `
                    <td><span class="file-icon"></span>${file.nombre}</td>
                    <td><span class="tag ${fileType}">${fileType.toUpperCase()}</span></td>
                    <td>${sizeMB}</td>
                    <td>${formattedDate}</td>
                    <td>${statusText}</td>
                    <td>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <button class="btn-preview" onclick="previewFile(${file.id})" title="Previsualizar archivo" style="display: inline-flex; align-items: center; padding: 4px 12px; font-size: 0.875rem; background-color: #9333ea; color: white; border-radius: 6px; border: none; cursor: pointer; white-space: nowrap; transition: background-color 0.2s;">
                         <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Ver
                            </button>
                            ${actionButton}
                            <div style="position: relative;">
                                <button class="dropdown-trigger" title="Más opciones">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="6" viewBox="0 0 20 6">
                                        <circle cx="3" cy="3" r="3" fill="currentColor" style="color: var(--color-texto-secundario);" />
                                        <circle cx="10" cy="3" r="3" fill="currentColor" style="color: var(--color-texto-secundario);" />
                                        <circle cx="17" cy="3" r="3" fill="currentColor" style="color: var(--color-texto-secundario);" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function optimizeFile(fileId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const button = document.querySelector(`[onclick="optimizeFile(${fileId})"]`);
            const originalText = button.innerHTML;

            button.innerHTML = `
                <svg class="animate-spin mr-1" width="14" height="14" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                    <path fill="currentColor" class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Procesando...
            `;
            button.disabled = true;

            fetch('/files/optimize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ id: fileId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.estadisticas) {
                        let statsMessage = 'Archivo optimizado exitosamente!\n\n';
                        if (data.estadisticas.filas_originales !== undefined) {
                            statsMessage += `Filas originales: ${data.estadisticas.filas_originales}\n`;
                        }
                        if (data.estadisticas.filas_limpias !== undefined) {
                            statsMessage += `Filas después de limpieza: ${data.estadisticas.filas_limpias}\n`;
                        }
                        if (data.estadisticas.anomalias && Object.keys(data.estadisticas.anomalias).length > 0) {
                            statsMessage += `Anomalías detectadas: ${JSON.stringify(data.estadisticas.anomalias, null, 2)}\n`;
                        }
                        Swal.fire({
                            title: '¡Archivo Optimizado!',
                            html: statsMessage.replace(/\n/g, '<br>'),
                            icon: 'success',
                            confirmButtonText: 'Continuar'
                        });
                    } else {
                        Swal.fire({
                            title: '¡Éxito!',
                            text: 'Archivo enviado a optimización',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                    setTimeout(() => loadFiles(), 1000);
                } else {
                    if (data.redirect) {
                        Swal.fire({
                            title: 'Sesión Expirada',
                            text: 'Tu sesión de Google ha expirado. Serás redirigido para reautorizar.',
                            icon: 'warning',
                            confirmButtonText: 'Continuar'
                        }).then(() => {
                            window.location.href = data.redirect;
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            confirmButtonText: 'Entendido'
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Error al optimizar el archivo',
                    icon: 'error',
                    confirmButtonText: 'Entendido'
                });
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // Funcionalidad de las pestañas
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remover clase active de todas las pestañas
                tabs.forEach(t => t.classList.remove('active'));
                // Agregar clase inactive a todas
                tabs.forEach(t => t.classList.add('inactive'));
                // Activar la pestaña clickeada
                this.classList.remove('inactive');
                this.classList.add('active');

                // Filtrar archivos según la pestaña
                const tabType = this.dataset.tab; // 'originales' o 'modificados'
                filterFilesByTab(tabType);
            });
        });

        // Filtrar archivos por pestaña
        function filterFilesByTab(tabType) {
            const rows = document.querySelectorAll('#filesTableBody tr');

            rows.forEach(row => {
                const fileStatus = row.dataset.fileStatus;

                if (tabType === 'todos') {
                    // Mostrar todos los archivos
                    row.style.display = '';
                } else if (tabType === 'originales') {
                    // Mostrar solo archivos originales (no modificados)
                    row.style.display = (fileStatus === 'original') ? '' : 'none';
                } else if (tabType === 'modificados') {
                    // Mostrar archivos modificados u optimizados
                    row.style.display = (fileStatus === 'optimizado' || fileStatus === 'pendiente') ? '' : 'none';
                }
            });
        }

        // Función para previsualizar archivo
        function previewFile(fileId) {
            // Redirigir a la página de previsualización
            window.location.href = `/files/preview?id=${fileId}`;
        }

        // Funcionalidad del menú desplegable
        document.addEventListener('click', function(e) {
            if (e.target.closest('.dropdown-trigger')) {
                const trigger = e.target.closest('.dropdown-trigger');
                e.stopPropagation();

                // Remover menús existentes
                document.querySelectorAll('.dropdown-menu').forEach(menu => menu.remove());

                // Crear menú desplegable
                const menu = document.createElement('div');
                menu.className = 'dropdown-menu fixed z-50 w-48 bg-white border border-gray-300 rounded-lg shadow-xl py-1';
                menu.innerHTML = `
                    <button class="flex items-center w-full px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                        <span class="font-medium">Eliminar archivo</span>
                    </button>
                `;

                // Posicionar el menú
                document.body.appendChild(menu);
                const rect = trigger.getBoundingClientRect();
                menu.style.top = (rect.bottom + window.scrollY) + 'px';
                menu.style.left = (rect.right - menu.offsetWidth + window.scrollX) + 'px';

                // Agregar funcionalidad al botón de borrar
                menu.querySelector('button').addEventListener('click', function() {
                    const fileId = trigger.closest('tr').dataset.fileId;
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

                    Swal.fire({
                        title: '¿Eliminar archivo?',
                        text: '¿Estás seguro de que quieres eliminar este archivo?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                        fetch('/files/delete?id=' + fileId, {
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remover la fila de la tabla
                                trigger.closest('tr').remove();
                                Swal.fire({
                                    title: '¡Eliminado!',
                                    text: 'Archivo eliminado correctamente',
                                    icon: 'success',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Error al eliminar el archivo: ' + data.message,
                                    icon: 'error',
                                    confirmButtonText: 'Entendido'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                title: 'Error',
                                text: 'Error al eliminar el archivo',
                                icon: 'error',
                                confirmButtonText: 'Entendido'
                            });
                        });
                        }
                    });
                    menu.remove();
                });

                // Cerrar menú al hacer clic fuera
                document.addEventListener('click', function closeMenu() {
                    if (!menu.contains(event.target) && !trigger.contains(event.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }
        });
    </script>



</body>

</html>
