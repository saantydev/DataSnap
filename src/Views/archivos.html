<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <title>Mis Bases de Datos - Datasnap - SISTEMA MVC FUNCIONANDO</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- CSRF token para fetch -->
    <meta name="csrf-token" content="<?php echo htmlspecialchars($_SESSION['csrf_token'] ?? ''); ?>">
    <link rel="stylesheet" href="/config/css/panel(prueba).css">
</head>

<body class="bg-white flex">
    <section max-height: 100vh, max-weight: 100vh>
        <div class="wave wave1"></div>
        <div class="wave wave2"></div>
        <div class="wave wave3"></div>
        <div class="wave wave4"></div>
    </section>
    <?php $active = 'files'; include __DIR__ . '/partials/sidebar.php'; ?>

    <main class="flex-1 relative ml-72">
        <header class="p-4 bg-white shadow-md">
            <h1 class="text-2xl font-bold text-gray-800">Mis Bases de Datos</h1>
        </header>

        <div class="p-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <span class="material-icons text-green-600 mr-2">check_circle</span>
                    <div>
                        <h3 class="text-green-800 font-medium">Sistema MVC Funcionando</h3>
                        <p class="text-green-600 text-sm">Usuario: <?php echo htmlspecialchars($userData['username'] ?? 'N/A'); ?> | ID: <?php echo htmlspecialchars($userData['id'] ?? 'N/A'); ?></p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Archivos Subidos</h2>
                    <p class="text-gray-600 mt-1">Gestiona tus bases de datos y archivos optimizados</p>
                </div>

                <div class="p-6">
                    <div class="mb-4 grid md:grid-cols-5 gap-3 items-end">
                        <div class="md:col-span-2">
                            <label for="searchInput" class="block text-sm font-medium text-gray-700">Buscar por nombre</label>
                            <input id="searchInput" type="text" placeholder="Escribe para filtrar..." class="mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label for="typeSelect" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="typeSelect" class="mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                                <option value="all">Todos</option>
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                                <option value="sql">SQL</option>
                                <option value="xlsx">XLSX</option>
                                <option value="xls">XLS</option>
                            </select>
                        </div>
                        <div>
                            <label for="rangeSelect" class="block text-sm font-medium text-gray-700">Antigüedad</label>
                            <select id="rangeSelect" class="mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                                <option value="all">Todos</option>
                                <option value="today">Hoy</option>
                                <option value="7d">Últimos 7 días</option>
                                <option value="30d">Últimos 30 días</option>
                                <option value="90d">Últimos 90 días</option>
                                <option value="year">Este año</option>
                            </select>
                        </div>
                        <div>
                            <label for="orderSelect" class="block text-sm font-medium text-gray-700">Orden</label>
                            <select id="orderSelect" class="mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                                <option value="desc">Nuevos primero</option>
                                <option value="asc">Antiguos primero</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button id="clearFilters" class="mt-6 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Limpiar</button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <p id="resultsCount" class="text-sm text-gray-600" aria-live="polite">Cargando...</p>
                    </div>

                    <div id="archivosContainer" class="space-y-4">
                        <!-- Lista -->
                        <div class="text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="text-gray-600 mt-4">Cargando archivos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para optimización -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Confirmar Optimización</h3>
                    <button id="closeConfirmModal" class="text-gray-500 hover:text-gray-700">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <p class="text-gray-600 mb-6">¿Estás seguro de que quieres optimizar este archivo? Este proceso puede tardar unos minutos.</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelOptimize" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmOptimize" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Optimizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de progreso -->
        <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Optimizando Archivo</h3>
                    <p class="text-gray-600">Por favor espera mientras procesamos tu archivo...</p>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para eliminación -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Confirmar Eliminación</h3>
                    <button id="closeDeleteModal" class="text-gray-500 hover:text-gray-700">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <p class="text-gray-600 mb-6">Esta acción marcará el archivo como eliminado. ¿Deseas continuar?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelDelete" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let archivos = [];
        let archivosFiltrados = [];
        let filtros = { search: '', type: 'all', range: 'all', order: 'desc' };
        let archivoAOptimizar = null;
        let archivoAEliminar = null;
        const CSRF_TOKEN = (document.querySelector('meta[name="csrf-token"]')?.content) || '';

        // Helpers de filtros y utilidades
        function debounce(fn, wait = 150) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), wait);
            };
        }
 
        function normalizar(str) {
            return (str || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }
 
        function getExtension(nombre) {
            const parts = (nombre || '').split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }
 
        function parseDate(val) {
            if (!val) return null;
            const s = typeof val === 'string' ? val.replace(' ', 'T') : val;
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }
 
        function isWithinRange(date, range) {
            if (!date) return false;
            if (range === 'all') return true;
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            switch (range) {
                case 'today':
                    return date >= startOfToday;
                case '7d': {
                    const d = new Date(); d.setDate(now.getDate() - 7); return date >= d;
                }
                case '30d': {
                    const d = new Date(); d.setDate(now.getDate() - 30); return date >= d;
                }
                case '90d': {
                    const d = new Date(); d.setDate(now.getDate() - 90); return date >= d;
                }
                case 'year':
                    return date.getFullYear() === now.getFullYear();
                default:
                    return true;
            }
        }
 
        function sortByFecha(arr, order = 'desc') {
            return arr.slice().sort((a, b) => {
                const da = parseDate(a.fecha_subida) || 0;
                const db = parseDate(b.fecha_subida) || 0;
                return order === 'asc' ? (da - db) : (db - da);
            });
        }
 
        function renderCount() {
            const countEl = document.getElementById('resultsCount');
            if (!countEl) return;
            const total = archivos.length;
            const filtered = archivosFiltrados.length;
            if (total === 0) {
                countEl.textContent = 'Sin archivos';
            } else {
                countEl.textContent = `${filtered} resultado${filtered !== 1 ? 's' : ''} de ${total}`;
            }
        }
 
        function applyFilters() {
            const search = filtros.search;
            const type = filtros.type;
            const range = filtros.range;
            const order = filtros.order;
            archivosFiltrados = archivos.filter(a => {
                const nameOk = normalizar(a.nombre).includes(search);
                const ext = getExtension(a.nombre);
                const typeOk = (type === 'all') ? true : (ext === type);
                const date = parseDate(a.fecha_subida);
                const rangeOk = isWithinRange(date, range);
                return nameOk && typeOk && rangeOk;
            });
            archivosFiltrados = sortByFecha(archivosFiltrados, order);
            mostrarArchivos(archivosFiltrados);
            renderCount();
        }
 
        function setupFilters() {
            const si = document.getElementById('searchInput');
            const ts = document.getElementById('typeSelect');
            const rs = document.getElementById('rangeSelect');
            const os = document.getElementById('orderSelect');
            const cf = document.getElementById('clearFilters');
            if (si) si.addEventListener('input', debounce(e => {
                filtros.search = normalizar(e.target.value);
                applyFilters();
            }, 150));
            if (ts) ts.addEventListener('change', e => {
                filtros.type = e.target.value;
                applyFilters();
            });
            if (rs) rs.addEventListener('change', e => {
                filtros.range = e.target.value;
                applyFilters();
            });
            if (os) os.addEventListener('change', e => {
                filtros.order = e.target.value;
                applyFilters();
            });
            if (cf) cf.addEventListener('click', () => {
                filtros = { search: '', type: 'all', range: 'all', order: 'desc' };
                if (si) si.value = '';
                if (ts) ts.value = 'all';
                if (rs) rs.value = 'all';
                if (os) os.value = 'desc';
                applyFilters();
            });
        }
 
        function mostrarConfirmacionEliminar(archivoId) {
            archivoAEliminar = archivoId;
            const modal = document.getElementById('deleteModal');
            if (modal) modal.classList.remove('hidden');
        }
 
        // Función para obtener archivos del usuario
        async function cargarArchivos() {
            try {
                const container = document.getElementById('archivosContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="text-gray-600 mt-4">Cargando archivos...</p>
                        </div>
                    `;
                }
 
                const response = await fetch('/files/list', {
                    method: 'GET',
                    credentials: 'same-origin', // Importante: enviar cookies de sesión
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
 
                const data = await response.json();
 
                if (data.success) {
                    archivos = data.archivos || [];
                    applyFilters();
                } else {
                    console.error('API Error:', data.message);
                    mostrarError('Error al cargar los archivos: ' + (data.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                mostrarError('Error de conexión: ' + error.message);
            }
        }

        // Función para mostrar archivos
        function mostrarArchivos(lista) {
            const container = document.getElementById('archivosContainer');
            if (!container) return;
 
            if (!lista || lista.length === 0) {
                if ((archivos || []).length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-icons text-6xl text-gray-300">storage</span>
                            <h3 class="text-xl font-medium text-gray-600 mt-4">No hay archivos subidos</h3>
                            <p class="text-gray-500 mt-2">Sube tu primer archivo para comenzar</p>
                            <a href="/panel" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 mt-4">
                                <span class="material-icons mr-2">add</span>
                                Subir Archivo
                            </a>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-icons text-6xl text-gray-300">filter_list_off</span>
                            <h3 class="text-xl font-medium text-gray-600 mt-4">Sin resultados</h3>
                            <p class="text-gray-500 mt-2">No hay coincidencias con los filtros actuales</p>
                            <button id="btnResetFilters" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 mt-4">
                                Limpiar filtros
                            </button>
                        </div>
                    `;
                    const btn = document.getElementById('btnResetFilters');
                    if (btn) btn.addEventListener('click', () => {
                        const cf = document.getElementById('clearFilters');
                        if (cf) cf.click();
                    });
                }
                return;
            }
 
            container.innerHTML = lista.map(archivo => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <span class="material-icons text-blue-600">
                                    ${getFileIcon(archivo.nombre)}
                                </span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">${archivo.nombre}</h4>
                                <p class="text-sm text-gray-500">
                                    Subido: ${(() => { const d = parseDate(archivo.fecha_subida); return d ? d.toLocaleDateString('es-ES') : 'N/D'; })()}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(archivo.estado)}">
                                ${getStatusText(archivo.estado)}
                            </span>
                            ${archivo.estado === 'original' ? `
                                <button onclick="mostrarConfirmacion(${archivo.id})"
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center">
                                    <span class="material-icons mr-1">auto_fix_high</span>
                                    Optimizar
                                </button>
                            ` : archivo.estado === 'optimizado' ? `
                                <button onclick="descargarArchivo(${archivo.id})"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center">
                                    <span class="material-icons mr-1">download</span>
                                    Descargar
                                </button>
                            ` : ''}
                            <button onclick="mostrarConfirmacionEliminar(${archivo.id})"
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center">
                                <span class="material-icons mr-1">delete</span>
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Función para mostrar confirmación de optimización
        function mostrarConfirmacion(archivoId) {
            archivoAOptimizar = archivoId;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        // Función para confirmar optimización
        document.getElementById('confirmOptimize').addEventListener('click', async () => {
    if (!archivoAOptimizar) return;

    document.getElementById('confirmModal').classList.add('hidden');
    document.getElementById('progressModal').classList.remove('hidden');

    try {
        const response = await fetch('https://datasnap-panel.onrender.com/procesar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: archivoAOptimizar })
        });

        if (response.ok) {
            mostrarMensaje('Archivo optimizado correctamente', 'success');
            setTimeout(cargarArchivos, 2000);
        } else {
            // Si Render devuelve error, mostramos mensaje y dejamos que el scheduler lo procese
            mostrarMensaje('No se pudo optimizar ahora, se hará automáticamente en unos minutos', 'error');
        }
    } catch (error) {
        console.error('Error al conectar con Render:', error);
        mostrarMensaje('Error de conexión, se optimizará en segundo plano', 'error');
    } finally {
        document.getElementById('progressModal').classList.add('hidden');
        archivoAOptimizar = null;
    }
});

        // Función para descargar archivo optimizado
        function descargarArchivo(archivoId) {
            window.location.href = `/files/download?id=${archivoId}`;
        }

        // Funciones auxiliares
        function getFileIcon(ruta) {
            const extension = ruta.split('.').pop().toLowerCase();
            switch (extension) {
                case 'csv': return 'table_chart';
                case 'json': return 'data_object';
                case 'sql': return 'database';
                default: return 'insert_drive_file';
            }
        }

        function getFileName(ruta) {
            return ruta.split('/').pop();
        }

        function getStatusClass(estado) {
            switch (estado) {
                case 'original': return 'bg-yellow-100 text-yellow-800';
                case 'pendiente': return 'bg-orange-100 text-orange-800';
                case 'optimizado': return 'bg-green-100 text-green-800';
                case 'borrado': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(estado) {
            switch (estado) {
                case 'original': return 'Original';
                case 'pendiente': return 'Procesando';
                case 'optimizado': return 'Optimizado';
                case 'borrado': return 'Eliminado';
                default: return estado;
            }
        }

        function mostrarError(mensaje) {
            const container = document.getElementById('archivosContainer');
            container.innerHTML = `
                <div class="text-center py-12">
                    <span class="material-icons text-6xl text-red-300">error</span>
                    <h3 class="text-xl font-medium text-red-600 mt-4">Error</h3>
                    <p class="text-red-500 mt-2">${mensaje}</p>
                    <button onclick="cargarArchivos()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Reintentar
                    </button>
                </div>
            `;
        }

        function mostrarMensaje(mensaje, tipo) {
            // Crear elemento de mensaje temporal
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 ${
                tipo === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            mensajeDiv.textContent = mensaje;

            document.body.appendChild(mensajeDiv);

            setTimeout(() => {
                mensajeDiv.remove();
            }, 5000);
        }

        // Event listeners
        document.getElementById('closeConfirmModal').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.add('hidden');
        });
 
        document.getElementById('cancelOptimize').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.add('hidden');
            archivoAOptimizar = null;
        });
 
        // Cerrar modal de optimización al hacer clic fuera
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                document.getElementById('confirmModal').classList.add('hidden');
                archivoAOptimizar = null;
            }
        });
 
        // Listeners modal de eliminación
        document.getElementById('closeDeleteModal').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
            archivoAEliminar = null;
        });
 
        document.getElementById('cancelDelete').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
            archivoAEliminar = null;
        });
 
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                document.getElementById('deleteModal').classList.add('hidden');
                archivoAEliminar = null;
            }
        });
 
        document.getElementById('confirmDelete').addEventListener('click', async () => {
            if (!archivoAEliminar) return;
            try {
                const resp = await fetch(`/files/delete?id=${archivoAEliminar}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': CSRF_TOKEN
                    }
                });
                const data = await resp.json();
                if (data.success) {
                    mostrarMensaje('Archivo eliminado correctamente', 'success');
                    document.getElementById('deleteModal').classList.add('hidden');
                    archivoAEliminar = null;
                    await cargarArchivos();
                } else {
                    mostrarMensaje(data.message || 'Error al eliminar el archivo', 'error');
                }
            } catch (err) {
                console.error('Error al eliminar:', err);
                mostrarMensaje('Error de conexión al eliminar', 'error');
            }
        });
 
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            setupFilters();
            cargarArchivos();
        });
    </script>
</body>
</html>